# Frontend Implementation Guide - MRF Workflow with Strict Role-Based Access Control

## Overview

This guide provides detailed specifications for implementing the frontend of the Material Request Form (MRF) workflow with strict role-based access control. **All actions and UI elements must be conditionally rendered based on the user's role and the MRF's current state.**

---

## 1. Role Definitions

### 1.1 Available Roles

```typescript
type UserRole = 
  | 'staff'           // Requester (can create MRF)
  | 'executive'        // Executive reviewer (e.g., Toplumi)
  | 'procurement'     // Procurement team
  | 'supply_chain_director'  // Supply Chain Director
  | 'finance'          // Finance team
  | 'admin';           // System administrator
```

---

## 2. Workflow States

### 2.1 MRF States

```typescript
type MRFState = 
  | 'mrf_created'           // Staff submitted MRF
  | 'executive_review'     // Executive reviewing
  | 'executive_approved'   // Executive approved
  | 'executive_rejected'   // Executive rejected
  | 'procurement_review'   // Procurement reviewing approved MRF
  | 'vendor_selected'      // Procurement selected vendor(s)
  | 'invoice_received'     // Vendor(s) submitted invoices
  | 'invoice_approved'     // Supply Chain Director approved invoice
  | 'po_generated'         // PO generated by Procurement
  | 'po_signed'            // PO signed (if required)
  | 'payment_processed'    // Finance processed payment
  | 'grn_requested'        // Finance requested GRN
  | 'grn_completed'        // Procurement uploaded GRN
  | 'closed';              // MRF closed (read-only)
```

---

## 3. API Endpoints

### 3.1 Get Available Actions

**Endpoint:** `GET /api/mrfs/{mrfId}/available-actions`

**Response:**
```typescript
{
  success: true,
  data: {
    canEdit: boolean,
    canApprove: boolean,
    canReject: boolean,
    canSelectVendors: boolean,
    canViewInvoices: boolean,
    canApproveInvoice: boolean,
    canGeneratePO: boolean,
    canSignPO: boolean,
    canProcessPayment: boolean,
    canRequestGRN: boolean,
    canUploadGRN: boolean,
    canViewGRN: boolean,
    availableActions: string[]  // List of action keys
  }
}
```

**Usage:**
```typescript
// Fetch available actions for current user
const response = await fetch(`/api/mrfs/${mrfId}/available-actions`, {
  headers: { 'Authorization': `Bearer ${token}` }
});
const { data } = await response.json();

// Conditionally render buttons
{data.canApprove && <ApproveButton />}
{data.canGeneratePO && <GeneratePOButton />}
```

---

## 4. Component Implementation

### 4.1 MRF Detail Page

```typescript
interface MRFDetailPageProps {
  mrfId: string;
  userRole: UserRole;
}

const MRFDetailPage: React.FC<MRFDetailPageProps> = ({ mrfId, userRole }) => {
  const [mrf, setMRF] = useState<MRF | null>(null);
  const [availableActions, setAvailableActions] = useState<AvailableActions | null>(null);
  
  useEffect(() => {
    // Fetch MRF details
    fetchMRFDetails(mrfId);
    // Fetch available actions
    fetchAvailableActions(mrfId);
  }, [mrfId]);
  
  return (
    <div>
      {/* MRF Information - Read-only for all users */}
      <MRFInfoSection mrf={mrf} />
      
      {/* Action Buttons - Conditionally rendered */}
      <ActionButtonsSection 
        availableActions={availableActions}
        mrf={mrf}
        userRole={userRole}
      />
      
      {/* Role-specific sections */}
      {userRole === 'procurement' && <ProcurementSection mrf={mrf} />}
      {userRole === 'finance' && <FinanceSection mrf={mrf} />}
    </div>
  );
};
```

### 4.2 Action Buttons Component

```typescript
interface ActionButtonsSectionProps {
  availableActions: AvailableActions | null;
  mrf: MRF | null;
  userRole: UserRole;
}

const ActionButtonsSection: React.FC<ActionButtonsSectionProps> = ({
  availableActions,
  mrf,
  userRole
}) => {
  // NEVER show buttons that are not in availableActions
  if (!availableActions) return null;
  
  return (
    <div className="action-buttons">
      {/* Executive Actions */}
      {availableActions.canApprove && userRole === 'executive' && (
        <ApproveButton mrfId={mrf?.id} />
      )}
      {availableActions.canReject && userRole === 'executive' && (
        <RejectButton mrfId={mrf?.id} />
      )}
      
      {/* Procurement Actions */}
      {availableActions.canSelectVendors && userRole === 'procurement' && (
        <SelectVendorsButton mrfId={mrf?.id} />
      )}
      {availableActions.canApproveInvoice && userRole === 'procurement' && (
        <ApproveInvoiceButton mrfId={mrf?.id} />
      )}
      {availableActions.canGeneratePO && userRole === 'procurement' && (
        <GeneratePOButton mrfId={mrf?.id} />
      )}
      
      {/* Supply Chain Director Actions */}
      {availableActions.canApproveInvoice && userRole === 'supply_chain_director' && (
        <ApproveInvoiceButton mrfId={mrf?.id} />
      )}
      
      {/* Finance Actions */}
      {availableActions.canProcessPayment && userRole === 'finance' && (
        <ProcessPaymentButton mrfId={mrf?.id} />
      )}
      {availableActions.canRequestGRN && userRole === 'finance' && (
        <RequestGRNButton mrfId={mrf?.id} />
      )}
      
      {/* Procurement GRN Upload */}
      {availableActions.canUploadGRN && userRole === 'procurement' && (
        <UploadGRNButton mrfId={mrf?.id} />
      )}
    </div>
  );
};
```

---

## 5. Role-Specific UI Components

### 5.1 Staff (Requester) View

**What Staff Can See:**
- Create MRF form
- View their own submitted MRFs (read-only)
- View MRF status and approval history
- **Cannot see:**
  - Edit button (after submission)
  - Procurement actions
  - Finance actions
  - PO generation button
  - Invoice information

**Implementation:**
```typescript
const StaffMRFView: React.FC<{ mrf: MRF }> = ({ mrf }) => {
  const canEdit = mrf.workflowState === 'mrf_created' && !mrf.submitted;
  
  return (
    <div>
      <MRFDetails mrf={mrf} readOnly={mrf.submitted} />
      
      {/* Only show edit if not submitted */}
      {canEdit && (
        <EditMRFButton mrfId={mrf.id} />
      )}
      
      {/* Status and history - always visible */}
      <MRFStatus mrf={mrf} />
      <ApprovalHistory mrf={mrf} />
    </div>
  );
};
```

### 5.2 Executive View

**What Executive Can See:**
- Full MRF details (read-only)
- Approve/Reject buttons (only when state is `executive_review`)
- Approval history
- **Cannot see:**
  - Edit button
  - Generate PO button
  - Procurement actions
  - Finance actions
  - Invoice information
  - Vendor selection

**Implementation:**
```typescript
const ExecutiveMRFView: React.FC<{ mrf: MRF, actions: AvailableActions }> = ({ mrf, actions }) => {
  return (
    <div>
      <MRFDetails mrf={mrf} readOnly={true} />
      
      {/* Only show approve/reject if available */}
      {actions.canApprove && (
        <ApproveMRFButton mrfId={mrf.id} />
      )}
      {actions.canReject && (
        <RejectMRFButton mrfId={mrf.id} />
      )}
      
      {/* Never show these */}
      {false && <GeneratePOButton />} {/* Hidden */}
      
      <ApprovalHistory mrf={mrf} />
    </div>
  );
};
```

### 5.3 Procurement View

**What Procurement Can See:**
- Full MRF details
- Vendor selection interface (when state is `procurement_review`)
- Invoice review interface (when invoices are received)
- Generate PO button (only after invoice approval)
- Upload GRN button (when GRN is requested)
- **Cannot see:**
  - Executive approval buttons
  - Finance payment processing (until PO is signed)

**Implementation:**
```typescript
const ProcurementMRFView: React.FC<{ mrf: MRF, actions: AvailableActions }> = ({ mrf, actions }) => {
  return (
    <div>
      <MRFDetails mrf={mrf} readOnly={true} />
      
      {/* Vendor Selection */}
      {actions.canSelectVendors && (
        <VendorSelectionSection mrfId={mrf.id} />
      )}
      
      {/* Invoice Review */}
      {actions.canViewInvoices && (
        <InvoiceReviewSection mrfId={mrf.id} invoices={mrf.invoices} />
      )}
      
      {/* Generate PO - Only after invoice approval */}
      {actions.canGeneratePO && (
        <GeneratePOButton mrfId={mrf.id} />
      )}
      
      {/* Upload GRN */}
      {actions.canUploadGRN && (
        <UploadGRNSection mrfId={mrf.id} />
      )}
    </div>
  );
};
```

### 5.4 Supply Chain Director View

**What Supply Chain Director Can See:**
- Full MRF details
- Invoice approval interface (when procurement selects vendor)
- **Cannot see:**
  - Generate PO button (only Procurement can see this)
  - Vendor selection interface
  - Finance actions

**Implementation:**
```typescript
const SupplyChainDirectorMRFView: React.FC<{ mrf: MRF, actions: AvailableActions }> = ({ mrf, actions }) => {
  return (
    <div>
      <MRFDetails mrf={mrf} readOnly={true} />
      
      {/* Invoice Approval */}
      {actions.canApproveInvoice && (
        <InvoiceApprovalSection 
          mrfId={mrf.id} 
          selectedInvoice={mrf.selectedInvoice}
        />
      )}
      
      {/* Never show PO generation */}
    </div>
  );
};
```

### 5.5 Finance View

**What Finance Can See:**
- Full MRF details
- PO information (read-only)
- Invoice information (read-only)
- Process Payment button (when PO is signed)
- Request GRN button (after payment processed)
- GRN review interface (when GRN is uploaded)
- **Cannot see:**
  - Generate PO button
  - Procurement actions
  - Executive approval buttons
  - Vendor selection

**Implementation:**
```typescript
const FinanceMRFView: React.FC<{ mrf: MRF, actions: AvailableActions }> = ({ mrf, actions }) => {
  return (
    <div>
      <MRFDetails mrf={mrf} readOnly={true} />
      <POInformation po={mrf.po} readOnly={true} />
      <InvoiceInformation invoice={mrf.selectedInvoice} readOnly={true} />
      
      {/* Process Payment */}
      {actions.canProcessPayment && (
        <ProcessPaymentButton mrfId={mrf.id} />
      )}
      
      {/* Request GRN */}
      {actions.canRequestGRN && (
        <RequestGRNButton mrfId={mrf.id} />
      )}
      
      {/* Review GRN */}
      {actions.canViewGRN && mrf.grn && (
        <GRNReviewSection grn={mrf.grn} />
      )}
    </div>
  );
};
```

---

## 6. Conditional Rendering Patterns

### 6.1 Using Available Actions API

**Best Practice:** Always fetch and use the `available-actions` endpoint rather than hardcoding conditions.

```typescript
// ✅ GOOD: Use API response
const { data: actions } = await fetchAvailableActions(mrfId);
{actions.canGeneratePO && <GeneratePOButton />}

// ❌ BAD: Hardcode conditions
{userRole === 'procurement' && mrf.state === 'invoice_approved' && <GeneratePOButton />}
```

### 6.2 Action Visibility Matrix

| Action | Staff | Executive | Procurement | Supply Chain Director | Finance |
|--------|-------|-----------|-------------|----------------------|---------|
| Create MRF | ✅ | ❌ | ❌ | ❌ | ❌ |
| Edit MRF (after submission) | ❌ | ❌ | ❌ | ❌ | ❌ |
| Approve/Reject MRF | ❌ | ✅ (when in review) | ❌ | ❌ | ❌ |
| Select Vendors | ❌ | ❌ | ✅ (when approved) | ❌ | ❌ |
| View Invoices | ❌ | ❌ | ✅ | ❌ | ✅ (read-only) |
| Approve Invoice | ❌ | ❌ | ❌ | ✅ (when selected) | ❌ |
| Generate PO | ❌ | ❌ | ✅ (after invoice approval) | ❌ | ❌ |
| Process Payment | ❌ | ❌ | ❌ | ❌ | ✅ (when PO signed) |
| Request GRN | ❌ | ❌ | ❌ | ❌ | ✅ (after payment) |
| Upload GRN | ❌ | ❌ | ✅ (when requested) | ❌ | ❌ |
| View GRN | ✅ (own MRF) | ✅ | ✅ | ✅ | ✅ |

---

## 7. Form Validation

### 7.1 MRF Creation Form

```typescript
const MRFCreationForm: React.FC = () => {
  const [formData, setFormData] = useState({
    title: '',
    category: '',
    urgency: 'medium',
    description: '',
    quantity: 0,
    estimatedCost: 0,
    justification: '',
  });
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation
    if (!formData.title || !formData.description || !formData.justification) {
      alert('Please fill all required fields');
      return;
    }
    
    // Submit - NO invoice upload at this stage
    await createMRF(formData);
  };
  
  return (
    <form onSubmit={handleSubmit}>
      {/* Form fields */}
      {/* NO invoice upload field */}
      <button type="submit">Submit MRF</button>
    </form>
  );
};
```

---

## 8. State Management

### 8.1 MRF State Management

```typescript
// Redux/Context example
interface MRFState {
  currentMRF: MRF | null;
  availableActions: AvailableActions | null;
  loading: boolean;
  error: string | null;
}

// Actions
const fetchMRFWithActions = async (mrfId: string) => {
  const [mrf, actions] = await Promise.all([
    fetchMRF(mrfId),
    fetchAvailableActions(mrfId)
  ]);
  
  return { mrf, actions };
};
```

---

## 9. Error Handling

### 9.1 Unauthorized Actions

```typescript
const handleAction = async (action: string, mrfId: string) => {
  try {
    // Always check available actions first
    const { data: actions } = await fetchAvailableActions(mrfId);
    
    if (!actions.availableActions.includes(action)) {
      throw new Error('Action not available for your role');
    }
    
    // Perform action
    await performAction(action, mrfId);
  } catch (error) {
    if (error.response?.status === 403) {
      // Hide the button and show message
      showError('You do not have permission to perform this action');
    }
  }
};
```

---

## 10. UI/UX Guidelines

### 10.1 Button Visibility

- **Never show disabled buttons** - If an action is not available, don't show the button at all
- **Use loading states** - Show loading indicators while fetching available actions
- **Provide feedback** - Show success/error messages after actions

### 10.2 Read-Only Indicators

```typescript
// Show clear read-only indicators
{mrf.workflowState === 'closed' && (
  <div className="read-only-banner">
    This MRF is closed and cannot be modified.
  </div>
)}

// Disable form inputs for read-only sections
<input 
  value={mrf.title} 
  readOnly={!canEdit}
  className={!canEdit ? 'read-only' : ''}
/>
```

---

## 11. Testing Checklist

### 11.1 Role-Based Visibility Tests

- [ ] Staff cannot see Generate PO button
- [ ] Executive cannot see Generate PO button
- [ ] Procurement cannot see Executive approval buttons
- [ ] Finance cannot see Procurement actions
- [ ] Supply Chain Director cannot see Generate PO button
- [ ] Closed MRFs show no action buttons

### 11.2 Action Availability Tests

- [ ] Approve button only shows for Executive when state is `executive_review`
- [ ] Generate PO button only shows for Procurement after invoice approval
- [ ] Process Payment button only shows for Finance when PO is signed
- [ ] Request GRN button only shows for Finance after payment processed

### 11.3 Form Validation Tests

- [ ] MRF creation form does not include invoice upload
- [ ] Edit button is hidden after MRF submission
- [ ] All forms validate required fields

---

## 12. API Integration Examples

### 12.1 Fetch Available Actions

```typescript
const fetchAvailableActions = async (mrfId: string): Promise<AvailableActions> => {
  const response = await fetch(`/api/mrfs/${mrfId}/available-actions`, {
    headers: {
      'Authorization': `Bearer ${getToken()}`,
      'Content-Type': 'application/json'
    }
  });
  
  if (!response.ok) {
    throw new Error('Failed to fetch available actions');
  }
  
  const { data } = await response.json();
  return data;
};
```

### 12.2 Perform Actions

```typescript
const approveMRF = async (mrfId: string, remarks?: string) => {
  const response = await fetch(`/api/mrfs/${mrfId}/approve`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${getToken()}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ remarks })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to approve MRF');
  }
  
  return response.json();
};
```

---

## 13. Security Best Practices

1. **Never trust frontend checks alone** - Backend must enforce all permissions
2. **Always fetch available actions** - Don't cache action availability
3. **Hide, don't disable** - Remove buttons entirely if action is unavailable
4. **Validate on submit** - Re-check permissions before submitting actions
5. **Handle 403 errors gracefully** - Show user-friendly messages

---

## 14. Summary

**Key Principles:**
1. ✅ Fetch available actions from API
2. ✅ Conditionally render UI based on role and state
3. ✅ Never show actions users cannot perform
4. ✅ Staff cannot edit after submission
5. ✅ Executive cannot see PO generation
6. ✅ Procurement handles vendor selection and PO generation
7. ✅ Finance handles payment and GRN requests
8. ✅ Closed MRFs are read-only

**Remember:** The backend enforces all permissions. The frontend should only show what the backend allows, but never rely solely on frontend checks for security.
